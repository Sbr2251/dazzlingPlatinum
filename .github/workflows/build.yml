name: Build Platinum ROM

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch: # Allows you to manually trigger the build from the Actions tab

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkitarm:latest # Official image with devkitARM pre-installed

    steps:
      # 1. Checkout the repository and submodules
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          submodules: recursive # Crucial: Pulls in necessary sub-tools

      # 2. Install dependencies specific to PokePlatinum
      # libpng-dev is needed for graphics tools; git/make are standard
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git libpng-dev libxml2-dev

      # 3. (Optional but Recommended) Verify Compilers exist
      # This step helps you debug if the build fails due to missing MWCC
      - name: Verify MWCC Compilers
        run: |
          if [ ! -d "tools/mwccarm" ]; then
            echo "::error::MetroWerks compilers not found in tools/mwccarm!"
            echo "You must commit the compilers to your repo for CI to work."
            exit 1
          fi

      # 4. Build the ROM
      # -j$(nproc) tells make to use all available CPU cores on the GitHub runner
      - name: Compile ROM
        run: make -j$(nproc)

      # 5. Upload the built artifacts
      # This saves the .nds file so you can download it from the GitHub website
      - name: Upload ROM Artifact
        uses: actions/upload-artifact@v4
        with:
          name: platinum-rom
          path: |
            *.nds
            *.xmap
            build/platinum.us/main.elf